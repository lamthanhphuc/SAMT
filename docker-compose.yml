version: "3.9"

# ==============================================
# SAMT MICROSERVICES - DOCKER COMPOSE
# ==============================================
# ⚠️ BẮT BUỘC: Tạo file .env từ .env.example trước khi chạy!
# ⚠️ KHÔNG DÙNG default credentials trong Production!
#
# Sử dụng:
#   1. cp .env.example .env
#   2. Sửa POSTGRES_PASSWORD trong .env
#   3. docker-compose up -d

services:

  # ========================================
  #   INFRASTRUCTURE SERVICES
  # ========================================

  postgres-identity:
    image: postgres:15-alpine
    container_name: postgres-identity
    env_file: .env
    environment:
      POSTGRES_DB: ${DB_IDENTITY_NAME:-samt_identity}
      POSTGRES_USER: ${POSTGRES_USER:?⚠️ POSTGRES_USER is required - create .env file}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?⚠️ POSTGRES_PASSWORD is required - create .env file}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "${POSTGRES_IDENTITY_PORT:-5432}:5432"
    volumes:
      - identity_data:/var/lib/postgresql/data
    networks:
      - samt-network
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  postgres-core:
    image: postgres:15-alpine
    container_name: postgres-core
    env_file: .env
    environment:
      POSTGRES_DB: ${DB_CORE_NAME:-samt_core}
      POSTGRES_USER: ${POSTGRES_USER:?⚠️ POSTGRES_USER is required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?⚠️ POSTGRES_PASSWORD is required}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "${POSTGRES_CORE_PORT:-5433}:5432"
    volumes:
      - core_data:/var/lib/postgresql/data
    networks:
      - samt-network
    deploy:
      resources:
        limits:
          cpus: "1.5"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  postgres-projectconfig:
    image: postgres:15-alpine
    container_name: postgres-projectconfig
    env_file: .env
    environment:
      POSTGRES_DB: ${DB_PROJECTCONFIG_NAME:-projectconfig_db}
      POSTGRES_USER: ${POSTGRES_USER:?⚠️ POSTGRES_USER is required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?⚠️ POSTGRES_PASSWORD is required}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "${POSTGRES_PROJECTCONFIG_PORT:-5434}:5432"
    volumes:
      - projectconfig_data:/var/lib/postgresql/data
    networks:
      - samt-network
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  postgres-usergroup:
    image: postgres:15-alpine
    container_name: postgres-usergroup
    env_file: .env
    environment:
      POSTGRES_DB: ${DB_USERGROUP_NAME:-samt_usergroup}
      POSTGRES_USER: ${POSTGRES_USER:?⚠️ POSTGRES_USER is required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?⚠️ POSTGRES_PASSWORD is required}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "${POSTGRES_USERGROUP_PORT:-5435}:5432"
    volumes:
      - usergroup_data:/var/lib/postgresql/data
    networks:
      - samt-network
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  postgres-sync:
    image: postgres:15-alpine
    container_name: postgres-sync
    env_file: .env
    environment:
      POSTGRES_DB: ${DB_SYNC_NAME:-sync_db}
      POSTGRES_USER: ${POSTGRES_USER:?⚠️ POSTGRES_USER is required}
      POSTGRES_PASSWORD: ${POSTGRES_PASSWORD:?⚠️ POSTGRES_PASSWORD is required}
      POSTGRES_INITDB_ARGS: "--encoding=UTF8 --locale=C"
    ports:
      - "${POSTGRES_SYNC_PORT:-5436}:5432"
    volumes:
      - sync_data:/var/lib/postgresql/data
    networks:
      - samt-network
    deploy:
      resources:
        limits:
          cpus: "1.0"
          memory: 512M
        reservations:
          cpus: "0.5"
          memory: 256M
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U $${POSTGRES_USER} -d $${POSTGRES_DB}"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    restart: unless-stopped

  kafka:
    image: confluentinc/cp-kafka:7.6.0
    container_name: kafka
    ports:
      - "9092:9092"
    environment:
      KAFKA_NODE_ID: 1
      KAFKA_PROCESS_ROLES: broker,controller
      KAFKA_LISTENERS: PLAINTEXT://0.0.0.0:29092,PLAINTEXT_HOST://0.0.0.0:9092,CONTROLLER://0.0.0.0:29093
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:29092,PLAINTEXT_HOST://localhost:9092
      KAFKA_CONTROLLER_LISTENER_NAMES: CONTROLLER
      KAFKA_LISTENER_SECURITY_PROTOCOL_MAP: CONTROLLER:PLAINTEXT,PLAINTEXT:PLAINTEXT,PLAINTEXT_HOST:PLAINTEXT
      KAFKA_CONTROLLER_QUORUM_VOTERS: 1@kafka:29093
      KAFKA_INTER_BROKER_LISTENER_NAME: PLAINTEXT
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      CLUSTER_ID: MkU3OEVBNTcwNTJENDM2Qk
    volumes:
      - kafka_data:/var/lib/kafka/data
    networks:
      - samt-network
    deploy:
      resources:
        limits:
          cpus: "2.0"
          memory: 1G
        reservations:
          cpus: "0.5"
          memory: 512M
    healthcheck:
      test: ["CMD-SHELL", "kafka-broker-api-versions --bootstrap-server localhost:9092 || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 5
      start_period: 30s
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    container_name: redis
    env_file: .env
    command: >
      redis-server 
      --appendonly yes 
      --maxmemory 256mb 
      --maxmemory-policy allkeys-lru
      --requirepass ${REDIS_PASSWORD:?⚠️ REDIS_PASSWORD is required - set in .env file}
    # SECURITY: No external port exposure in production
    # Uncomment only for development debugging:
    # ports:
    #   - "${REDIS_PORT:-6379}:6379"
    volumes:
      - redis_data:/data
    networks:
      - samt-network
    deploy:
      resources:
        limits:
          cpus: "0.5"
          memory: 256M
        reservations:
          cpus: "0.25"
          memory: 128M
    healthcheck:
      test: ["CMD", "redis-cli", "-a", "${REDIS_PASSWORD}", "ping"]
      interval: 10s
      timeout: 3s
      retries: 5
      start_period: 5s
    restart: unless-stopped

  # ========================================
  #   APPLICATION SERVICES
  # ========================================
#
#  identity-service:
#    build:
#      context: ./identity-service
#      dockerfile: Dockerfile
#      args:
#        JAR_FILE: target/*.jar
#    container_name: identity-service
#    env_file: .env
#    environment:
#      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
#      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-identity:5432/${DB_IDENTITY_NAME:-samt_identity}?serverTimezone=UTC
#      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
#      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
#      SPRING_DATA_REDIS_HOST: redis
#      SPRING_DATA_REDIS_PORT: 6379
#      SERVER_PORT: 8081
#      GRPC_SERVER_PORT: 9091
#      JAVA_OPTS: ${JAVA_OPTS:--Xms256m -Xmx512m}
#    ports:
#      - "${IDENTITY_SERVICE_PORT:-8081}:8081"
#      - "${IDENTITY_SERVICE_GRPC_PORT:-9091}:9091"
#    depends_on:
#      postgres-identity:
#        condition: service_healthy
#      redis:
#        condition: service_healthy
#    networks:
#      - samt-network
#    deploy:
#      resources:
#        limits:
#          cpus: "1.0"
#          memory: 768M
#        reservations:
#          cpus: "0.5"
#          memory: 512M
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8081/actuator/health"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 40s
#    restart: unless-stopped
#
#  user-group-service:
#    build:
#      context: ./user-group-service
#      dockerfile: Dockerfile
#      args:
#        JAR_FILE: target/*.jar
#    container_name: user-group-service
#    env_file: .env
#    environment:
#      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
#      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-usergroup:5432/${DB_USERGROUP_NAME:-samt_usergroup}?serverTimezone=UTC
#      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
#      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
#      SERVER_PORT: 8082
#      GRPC_SERVER_PORT: 9095
#      IDENTITY_SERVICE_GRPC_HOST: identity-service
#      IDENTITY_SERVICE_GRPC_PORT: 9091
#      KAFKA_ENABLED: ${KAFKA_ENABLED:-true}
#      KAFKA_BOOTSTRAP_SERVERS: kafka:29092
#      JAVA_OPTS: ${JAVA_OPTS:--Xms256m -Xmx512m}
#    ports:
#      - "${USER_GROUP_SERVICE_PORT:-8082}:8082"
#      - "${USER_GROUP_SERVICE_GRPC_PORT:-9095}:9095"
#    depends_on:
#      postgres-usergroup:
#        condition: service_healthy
#      identity-service:
#        condition: service_healthy
#      kafka:
#        condition: service_healthy
#    networks:
#      - samt-network
#    deploy:
#      resources:
#        limits:
#          cpus: "1.0"
#          memory: 768M
#        reservations:
#          cpus: "0.5"
#          memory: 512M
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8082/actuator/health"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 60s
#    restart: unless-stopped

  # ========================================
  #   OTHER SERVICES (commented - uncomment when needed)
  # ========================================

#  api-gateway:
#    build:
#      context: ./api-gateway
#      dockerfile: Dockerfile
#      args:
#        JAR_FILE: target/*.jar
#    container_name: api-gateway
#    env_file: .env
#    environment:
#      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
#      SPRING_DATA_REDIS_HOST: redis
#      SPRING_DATA_REDIS_PORT: 6379
#      SPRING_DATA_REDIS_PASSWORD: ${REDIS_PASSWORD}
#      JAVA_OPTS: ${JAVA_OPTS:--Xms256m -Xmx512m}
#    ports:
#      - "${API_GATEWAY_PORT:-9080}:8080"
#    depends_on:
#      redis:
#        condition: service_healthy
#      identity-service:
#        condition: service_healthy
#    networks:
#      - samt-network
#    deploy:
#      resources:
#        limits:
#          cpus: "1.0"
#          memory: 768M
#        reservations:
#          cpus: "0.5"
#          memory: 512M
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 40s
#    restart: unless-stopped
#
#  identity-service:
#    build:
#      context: ./identity-service
#      dockerfile: Dockerfile
#      args:
#        JAR_FILE: target/*.jar
#    container_name: identity-service
#    env_file: .env
#    environment:
#      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
#      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-identity:5432/${DB_IDENTITY_NAME:-samt_identity}?serverTimezone=UTC
#      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
#      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
#      SPRING_DATA_REDIS_HOST: redis
#      SPRING_DATA_REDIS_PORT: 6379
#      JAVA_OPTS: ${JAVA_OPTS:--Xms256m -Xmx512m}
#    ports:
#      - "${IDENTITY_SERVICE_PORT:-8081}:8080"
#    depends_on:
#      postgres-identity:
#        condition: service_healthy
#      redis:
#        condition: service_healthy
#    networks:
#      - samt-network
#    deploy:
#      resources:
#        limits:
#          cpus: "1.0"
#          memory: 768M
#        reservations:
#          cpus: "0.5"
#          memory: 512M
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 40s
#    restart: unless-stopped
#
#  sync-service:
#    build:
#      context: ./sync-service
#      dockerfile: Dockerfile
#      args:
#        JAR_FILE: target/*.jar
#    container_name: sync-service
#    env_file: .env
#    environment:
#      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
#      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-sync:5432/${DB_SYNC_NAME:-sync_db}?serverTimezone=UTC
#      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
#      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
#      SPRING_DATA_REDIS_HOST: redis
#      SPRING_DATA_REDIS_PORT: 6379
#      JAVA_OPTS: ${JAVA_OPTS:--Xms256m -Xmx512m}
#    ports:
#      - "${SYNC_SERVICE_PORT:-8084}:8080"
#    depends_on:
#      postgres-sync:
#        condition: service_healthy
#      redis:
#        condition: service_healthy
#    networks:
#      - samt-network
#    deploy:
#      resources:
#        limits:
#          cpus: "1.0"
#          memory: 768M
#        reservations:
#          cpus: "0.5"
#          memory: 512M
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 40s
#    restart: unless-stopped
#
#  analysis-service:
#    build:
#      context: ./analysis-service
#      dockerfile: Dockerfile
#      args:
#        JAR_FILE: target/*.jar
#    container_name: analysis-service
#    env_file: .env
#    environment:
#      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
#      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-core:5432/${DB_CORE_NAME:-samt_core}?serverTimezone=UTC
#      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
#      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
#      SPRING_DATA_REDIS_HOST: redis
#      SPRING_DATA_REDIS_PORT: 6379
#      JAVA_OPTS: ${JAVA_OPTS:--Xms256m -Xmx512m}
#    ports:
#      - "${ANALYSIS_SERVICE_PORT:-8083}:8080"
#    depends_on:
#      postgres-core:
#        condition: service_healthy
#      redis:
#        condition: service_healthy
#    networks:
#      - samt-network
#    deploy:
#      resources:
#        limits:
#          cpus: "1.0"
#          memory: 768M
#        reservations:
#          cpus: "0.5"
#          memory: 512M
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 40s
#    restart: unless-stopped
#
#  report-service:
#    build:
#      context: ./report-service
#      dockerfile: Dockerfile
#      args:
#        JAR_FILE: target/*.jar
#    container_name: report-service
#    env_file: .env
#    environment:
#      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
#      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-core:5432/${DB_CORE_NAME:-samt_core}?serverTimezone=UTC
#      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
#      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
#      SPRING_DATA_REDIS_HOST: redis
#      SPRING_DATA_REDIS_PORT: 6379
#      JAVA_OPTS: ${JAVA_OPTS:--Xms256m -Xmx512m}
#    ports:
#      - "${REPORT_SERVICE_PORT:-8084}:8080"
#    depends_on:
#      postgres-core:
#        condition: service_healthy
#      redis:
#        condition: service_healthy
#    networks:
#      - samt-network
#    deploy:
#      resources:
#        limits:
#          cpus: "1.0"
#          memory: 768M
#        reservations:
#          cpus: "0.5"
#          memory: 512M
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 40s
#    restart: unless-stopped
#
#  notification-service:
#    build:
#      context: ./notification-service
#      dockerfile: Dockerfile
#      args:
#        JAR_FILE: target/*.jar
#    container_name: notification-service
#    env_file: .env
#    environment:
#      SPRING_PROFILES_ACTIVE: ${SPRING_PROFILES_ACTIVE:-docker}
#      SPRING_DATASOURCE_URL: jdbc:postgresql://postgres-core:5432/${DB_CORE_NAME:-samt_core}?serverTimezone=UTC
#      SPRING_DATASOURCE_USERNAME: ${POSTGRES_USER}
#      SPRING_DATASOURCE_PASSWORD: ${POSTGRES_PASSWORD}
#      SPRING_DATA_REDIS_HOST: redis
#      SPRING_DATA_REDIS_PORT: 6379
#      JAVA_OPTS: ${JAVA_OPTS:--Xms256m -Xmx512m}
#    ports:
#      - "${NOTIFICATION_SERVICE_PORT:-8085}:8080"
#    depends_on:
#      postgres-core:
#        condition: service_healthy
#      redis:
#        condition: service_healthy
#    networks:
#      - samt-network
#    deploy:
#      resources:
#        limits:
#          cpus: "1.0"
#          memory: 768M
#        reservations:
#          cpus: "0.5"
#          memory: 512M
#    healthcheck:
#      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:8080/actuator/health"]
#      interval: 30s
#      timeout: 10s
#      retries: 3
#      start_period: 40s
#    restart: unless-stopped

# ========================================
#   NETWORKS & VOLUMES
# ========================================

networks:
  samt-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.20.0.0/16

volumes:
  identity_data:
    driver: local
  core_data:
    driver: local
  projectconfig_data:
    driver: local
  usergroup_data:
    driver: local
  sync_data:
    driver: local
  redis_data:
    driver: local
  kafka_data:
    driver: local
