# ==============================================
# API GATEWAY - PRODUCTION CONFIG
# ==============================================

server:
  port: ${SERVER_PORT:8080}
  shutdown: graceful

spring:
  application:
    name: api-gateway

  lifecycle:
    timeout-per-shutdown-phase: 30s

  codec:
    max-in-memory-size: 10MB

  data:
    redis:
      host: ${SPRING_DATA_REDIS_HOST:redis}
      port: ${SPRING_DATA_REDIS_PORT:6379}
      timeout: 3000ms

  cloud:
    gateway:

      httpclient:
        connect-timeout: 3000
        response-timeout: 30s

      default-filters: 
        - name: RateLimitHeaders
          args:
            limit: 100  # Default rate limit for header calculation

      redis-rate-limiter:
        replenishRate: 100
        burstCapacity: 200

      routes:

        # ==========================================
        # IDENTITY SERVICE
        # ==========================================
        - id: identity-service
          uri: http://identity-service:8081
          predicates:
            - Path=/api/identity/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                key-resolver: '#{@ipKeyResolver}'
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
            - name: RateLimitHeaders
              args:
                limit: 20  # Match burst capacity for accurate headers

        # ==========================================
        # USER-GROUP SERVICE
        # ==========================================
        - id: user-group-service
          uri: http://user-group-service:8082
          predicates:
            - Path=/api/groups/**,/api/users/**
          filters:
            - StripPrefix=1
            - name: RequestRateLimiter
              args:
                key-resolver: '#{@ipKeyResolver}'

        # ==========================================
        # PROJECT CONFIG SERVICE
        # ==========================================
        - id: project-config-service
          uri: http://project-config-service:8083
          predicates:
            - Path=/api/project-configs/**
          filters:
            - StripPrefix=2
            - name: RequestSize
              args:
                maxSize: 1MB  # Config files are typically small
            - name: RequestRateLimiter
              args:
                key-resolver: '#{@ipKeyResolver}'

        # ==========================================
        # SYNC SERVICE
        # ==========================================
        - id: sync-service
          uri: http://sync-service:8084
          predicates:
            - Path=/api/sync/**
          filters:
            - StripPrefix=2
            - name: RequestSize
              args:
                maxSize: 3MB  # Sync data can be moderate size
            - name: RequestRateLimiter
              args:
                key-resolver: '#{@ipKeyResolver}'

        # ==========================================
        # ANALYSIS SERVICE
        # ==========================================
        - id: analysis-service
          uri: http://analysis-service:8085
          predicates:
            - Path=/api/analysis/**
          filters:
            - StripPrefix=2
            - name: RequestSize
              args:
                maxSize: 2MB  # Analysis data files
            - name: RequestRateLimiter
              args:
                key-resolver: '#{@ipKeyResolver}'

        # ==========================================
        # REPORT SERVICE
        # ==========================================
        - id: report-service
          uri: http://report-service:8086
          predicates:
            - Path=/api/reports/**
          filters:
            - StripPrefix=2
            - name: RequestSize
              args:
                maxSize: 5MB  # Reports may include larger datasets
            - name: RequestRateLimiter
              args:
                key-resolver: '#{@ipKeyResolver}'


# ==============================================
# GATEWAY CONFIGURATION
# ==============================================
gateway:
  internal:
    secret: ${GATEWAY_INTERNAL_SECRET}

# ==============================================
# JWT CONFIGURATION
# ==============================================
# MUST be provided via environment variable
jwt:
  secret: ${JWT_SECRET}


# ==============================================
# SPRINGDOC (Aggregated Swagger)
# ==============================================
springdoc:
  swagger-ui:
    enabled: ${SWAGGER_ENABLED:false}  # Disabled by default for security - set SWAGGER_ENABLED=true for development
    path: /swagger-ui.html
    urls:
      - name: Identity Service
        url: /api/identity/v3/api-docs
      - name: User-Group Service  
        url: /api/users/v3/api-docs
      - name: Project Config Service
        url: /api/project-configs/v3/api-docs
  api-docs:
    enabled: ${SWAGGER_ENABLED:false}  # Disabled by default for security


# ==============================================
# MANAGEMENT
# ==============================================
management:
  endpoints:
    web:
      exposure:
        include: health  # Only health endpoint exposed, others require authentication
  endpoint:
    health:
      show-details: when-authorized


# ==============================================
# LOGGING
# ==============================================
logging:
  level:
    root: ${LOG_LEVEL:INFO}
    com.example.gateway: ${LOG_LEVEL:DEBUG}
    org.springframework.cloud.gateway: ${GATEWAY_LOG_LEVEL:INFO}
  pattern:
    console: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%X{requestId:-}] %logger{36} - %msg%n"
    file: "%d{yyyy-MM-dd HH:mm:ss} [%thread] %-5level [%X{requestId:-}] %logger{36} - %msg%n"