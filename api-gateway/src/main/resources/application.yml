# ==============================================
# API GATEWAY - APPLICATION CONFIG
# ==============================================
# Architecture: Client → REST/JSON → Gateway → gRPC Transcoding → Microservices
# - JWT validation tại Gateway
# - Inject user info (userId, email, role) vào headers
# - gRPC metadata được tự động forward cho services

server:
  port: ${SERVER_PORT:8080}
  shutdown: graceful

spring:
  application:
    name: api-gateway

  lifecycle:
    timeout-per-shutdown-phase: 30s

  data:
    redis:
      host: ${SPRING_DATA_REDIS_HOST:redis}
      port: ${SPRING_DATA_REDIS_PORT:6379}
      timeout: 3000ms
      lettuce:
        pool:
          max-active: 8
          max-idle: 8
          min-idle: 2

  cloud:
    gateway:
      default-filters: [] # Disable implicit default filters for strict order
      routes:
        - id: identity-service
          uri: http://identity-service:8081
          predicates:
            - Path=/api/identity/**
          filters:
            - name: CorsWebFilter
              args: { order: 0 }
            - name: JwtAuthenticationFilter
              args: { order: 1 }
            - name: SignedHeaderFilter
              args: { order: 2 }
            - name: RequestRateLimiter
              args:
                order: 3
                key-resolver: '#{@ipKeyResolver}'
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20
            - StripPrefix=2
            - AddRequestHeader=X-Forwarded-Host, gateway

        - id: login-endpoint
          uri: http://identity-service:8081
          predicates:
            - Path=/login
          filters:
            - name: CorsWebFilter
              args: { order: 0 }
            - name: JwtAuthenticationFilter
              args: { order: 1 }
            - name: SignedHeaderFilter
              args: { order: 2 }
            - name: RequestRateLimiter
              args:
                order: 3
                key-resolver: '#{@ipKeyResolver}'
                redis-rate-limiter.replenishRate: 5
                redis-rate-limiter.burstCapacity: 10
            - AddRequestHeader=X-Forwarded-Host, gateway

        - id: register-endpoint
          uri: http://identity-service:8081
          predicates:
            - Path=/register
          filters:
            - name: CorsWebFilter
              args: { order: 0 }
            - name: JwtAuthenticationFilter
              args: { order: 1 }
            - name: SignedHeaderFilter
              args: { order: 2 }
            - name: RequestRateLimiter
              args:
                order: 3
                key-resolver: '#{@ipKeyResolver}'
                redis-rate-limiter.replenishRate: 2
                redis-rate-limiter.burstCapacity: 5
            - AddRequestHeader=X-Forwarded-Host, gateway

# ==============================================
# JWT CONFIGURATION
# ==============================================
# CRITICAL: jwt.secret PHẢI giống Identity Service
jwt:
  secret: ${JWT_SECRET:your-256-bit-secret-key-change-this-in-production-environment-please}

# ==============================================
# SWAGGER CONFIGURATION
# ==============================================
# Aggregated Swagger UI tại Gateway
springdoc:
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    urls:
      - name: Identity Service
        url: http://identity-service:8081/v3/api-docs
      - name: User-Group Service
        url: http://user-group-service:8082/v3/api-docs
  api-docs:
    enabled: true

# ==============================================
# MANAGEMENT & MONITORING
# ==============================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway
  endpoint:
    health:
      show-details: when-authorized

logging:
  level:
    root: ${LOG_LEVEL:INFO}
    com.example.gateway: ${LOG_LEVEL:DEBUG}
    org.springframework.cloud.gateway: ${GATEWAY_LOG_LEVEL:INFO}

logging:
  level:
    root: ${LOG_LEVEL:INFO}
    org.springframework.cloud.gateway: ${GATEWAY_LOG_LEVEL:DEBUG}

---
# ==============================================
# LOCAL PROFILE (for IDE development)
# ==============================================
spring:
  config:
    activate:
      on-profile: local

  cloud:
    gateway:
      routes:
        - id: identity-service
          uri: http://localhost:8081
          predicates:
            - Path=/identity/**
          filters:
            - StripPrefix=1

        - id: sync-service
          uri: http://localhost:8082
          predicates:
            - Path=/sync/**
          filters:
            - StripPrefix=1

        - id: analysis-service
          uri: http://localhost:8083
          predicates:
            - Path=/analysis/**
          filters:
            - StripPrefix=1

        - id: report-service
          uri: http://localhost:8084
          predicates:
            - Path=/report/**
          filters:
            - StripPrefix=1

        - id: notification-service
          uri: http://localhost:8085
          predicates:
            - Path=/notification/**
          filters:
            - StripPrefix=1

  data:
    redis:
      host: localhost

server:
  port: 9080
