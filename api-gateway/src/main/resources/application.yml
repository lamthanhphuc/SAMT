# ==============================================
# API GATEWAY - PRODUCTION CONFIG
# ==============================================

server:
  port: ${SERVER_PORT:8080}
  shutdown: graceful

spring:
  application:
    name: api-gateway

  lifecycle:
    timeout-per-shutdown-phase: 30s

  codec:
    max-in-memory-size: 10MB

  data:
    redis:
      host: ${SPRING_DATA_REDIS_HOST:redis}
      port: ${SPRING_DATA_REDIS_PORT:6379}
      timeout: 3000ms

  cloud:
    gateway:

      httpclient:
        connect-timeout: 3000
        response-timeout: 30s

      default-filters: []   # Strict filter order control

      redis-rate-limiter:
        replenishRate: 100
        burstCapacity: 200

      routes:

        # ==========================================
        # IDENTITY SERVICE
        # ==========================================
        - id: identity-service
          uri: http://identity-service:8081
          predicates:
            - Path=/api/identity/**
          filters:
            - StripPrefix=2
            - name: RequestRateLimiter
              args:
                key-resolver: '#{@ipKeyResolver}'
                redis-rate-limiter.replenishRate: 10
                redis-rate-limiter.burstCapacity: 20

        # ==========================================
        # USER-GROUP SERVICE
        # ==========================================
        - id: user-group-service
          uri: http://user-group-service:8082
          predicates:
            - Path=/api/groups/**,/api/users/**
          filters:
            - StripPrefix=1
            - name: RequestRateLimiter
              args:
                key-resolver: '#{@ipKeyResolver}'

        # ==========================================
        # PROJECT CONFIG SERVICE
        # ==========================================
        - id: project-config-service
          uri: http://project-config-service:8083
          predicates:
            - Path=/api/project-configs/**
          filters:
            - StripPrefix=2

        # ==========================================
        # SYNC SERVICE
        # ==========================================
        - id: sync-service
          uri: http://sync-service:8084
          predicates:
            - Path=/api/sync/**
          filters:
            - StripPrefix=2

        # ==========================================
        # ANALYSIS SERVICE
        # ==========================================
        - id: analysis-service
          uri: http://analysis-service:8085
          predicates:
            - Path=/api/analysis/**
          filters:
            - StripPrefix=2

        # ==========================================
        # REPORT SERVICE
        # ==========================================
        - id: report-service
          uri: http://report-service:8086
          predicates:
            - Path=/api/reports/**
          filters:
            - StripPrefix=2


# ==============================================
# JWT CONFIGURATION
# ==============================================
# MUST be provided via environment variable
jwt:
  secret: ${JWT_SECRET}


# ==============================================
# SPRINGDOC (Aggregated Swagger)
# ==============================================
springdoc:
  swagger-ui:
    enabled: true
    path: /swagger-ui.html
    urls:
      - name: Identity Service
        url: http://identity-service:8081/v3/api-docs
      - name: User-Group Service
        url: http://user-group-service:8082/v3/api-docs
      - name: Project Config Service
        url: http://project-config-service:8083/v3/api-docs
  api-docs:
    enabled: true


# ==============================================
# MANAGEMENT
# ==============================================
management:
  endpoints:
    web:
      exposure:
        include: health,info,metrics,gateway
  endpoint:
    health:
      show-details: when-authorized


# ==============================================
# LOGGING
# ==============================================
logging:
  level:
    root: ${LOG_LEVEL:INFO}
    com.example.gateway: ${LOG_LEVEL:DEBUG}
    org.springframework.cloud.gateway: ${GATEWAY_LOG_LEVEL:INFO}